"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_Pubsub=_interopRequireDefault(require("../../lib/Pubsub")),_context=require("../context"),_bidManager=_interopRequireDefault(require("../../utils/bidManager")),_timedPromise=_interopRequireDefault(require("../../utils/timedPromise")),_googletag=require("../../utils/googletag");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,c):{};d.get||d.set?Object.defineProperty(b,c,d):b[c]=a[c]}return b.default=a,b}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var STARTED="STARTED",SUCCESS="SUCCESS",FAIL="FAIL",Provider=function(a){function b(a){var c;_classCallCheck(this,b),c=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,a)),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"initGPT",function(){var a=_assertThisInitialized(_assertThisInitialized(c)),b=a.props,d=b.gpt;d.createGPTScript(),d.setCentering(b.setCentering),d.setAdIframeTitle(b.adIframeTitle),d.enableVideoAds(b.enableVideoAds),d.collapseEmptyDivs(b.collapseEmptyDivs),d.enableAsyncRendering(!0),d.enableSingleRequest(!0),d.disableInitialLoad(!0),d.setTargeting(b.targeting),d.enableServices(),d.destroySlots()}),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"initBidders",function(){c.props.bidProviders.length?(0,_timedPromise.default)(c.props.bidProviders.map(function(a){return a._init()}),c.props.initTimeout).catch(function(a){return console.log("Error initializing bidders",a)}).finally(function(){return c.pubsub.emit("bidders-ready",!0)}):c.pubsub.emit("bidders-ready",!0)}),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"loadVideoScripts",function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"postfix";return new Promise(function(c,d){var e=setTimeout(d,4e3),f=a.length,g=function(){--f,0>=f&&(clearTimeout(e),c())},h=document.createDocumentFragment();a.forEach(function(a,c){var d="instream-js-".concat(c+b),e=document.getElementById(d);if(e)return g();var f=document.createElement("script");f.src=a,f.id=d,f.async=!0,f.defer=!0,f.onload=g,f.onerror=g,h.appendChild(f)}),document.head.appendChild(h)})}),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"loadVideoCss",function(){return new Promise(function(a,b){var c=setTimeout(b,4e3),d=["https://cdnjs.cloudflare.com/ajax/libs/video.js/7.5.0/video-js.min.css","https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.6.1/videojs-contrib-ads.min.css","https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/1.5.2/videojs.ima.min.css"],e=d.length,f=function(){--e,0>=e&&(clearTimeout(c),a())},g=document.createDocumentFragment();d.forEach(function(a,b){var c="instream-css-".concat(b),d=document.getElementById(c);if(d)return f();var e=document.createElement("link");e.href=a,e.id=c,e.rel="stylesheet",e.onload=f,e.onerror=f,g.appendChild(e)}),document.head.appendChild(g)})}),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"loadVideoPlayer",function(a){if(c.videoStatus!==FAIL)return c.videoStatus===STARTED?c.videoQue.push(a):c.videoStatus===SUCCESS?a():(""===c.videoStatus&&(c.videoQue.push(a),c.videoStatus=STARTED),c.loadVideoScripts(["https://cdnjs.cloudflare.com/ajax/libs/video.js/7.5.0/video.min.js"],"-1").then(function(){return c.loadVideoScripts(["//imasdk.googleapis.com/js/sdkloader/ima3.js","https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.6.1/videojs-contrib-ads.min.js","https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/1.5.2/videojs.ima.min.js"])},"-2").then(function(){return c.loadVideoCss()}).then(function(){c.videoStatus=SUCCESS,c.videoQue.forEach(function(a){return a()})}).catch(function(){c.videoStatus=FAIL}))}),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"generateId",function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ad";return c.slotCount[a],isNaN(c.slotCount[a])?c.slotCount[a]=1:++c.slotCount[a],"".concat(a).concat(c.props.divider).concat(c.slotCount[a])}),_defineProperty(_assertThisInitialized(_assertThisInitialized(c)),"refreshAdById",function(a){[].concat(a).forEach(function(a){window.dispatchEvent(new CustomEvent("refresh-ad",{detail:{id:a}}))})});var d=a.gpt;return a.enableAds?(c.pubsub=a.pubsub,c.slotCount={},c.initGPT(),c.bidManager=(0,_bidManager.default)({refresh:d.refresh,chunkSize:a.chunkSize,bidTimeout:a.bidTimeout,bidProviders:a.bidProviders,refreshDelay:a.refreshDelay,onBiddersReady:function b(a){return c.pubsub.on("bidders-ready",a)}}),c.initBidders(),c.videoStatus="",c.videoQue=[],c):_possibleConstructorReturn(c)}return _inherits(b,a),_createClass(b,[{key:"componentWillUnmount",value:function a(){this.props.enableAds&&this.pubsub.clear()}},{key:"render",value:function a(){return _react.default.createElement(_context.AdsContext.Provider,{value:{generateId:this.generateId,enableAds:this.props.enableAds,networkId:this.props.networkId,refresh:this.bidManager.refresh,adUnitPath:this.props.adUnitPath,bidHandler:this.props.bidHandler,lazyOffset:this.props.lazyOffset,refreshAdById:this.refreshAdById,loadVideoPlayer:this.loadVideoPlayer}},this.props.children)}}]),b}(_react.Component);Provider.defaultProps={divider:"_",networkId:0,chunkSize:5,targeting:{},enableAds:!0,lazyOffset:800,bidProviders:[],bidTimeout:1e3,initTimeout:350,refreshDelay:200,adIframeTitle:"",setCentering:!0,pubsub:new _Pubsub.default,bidHandler:void 0,enableVideoAds:!1,collapseEmptyDivs:!1,gpt:{refresh:_googletag.refresh,setCentering:_googletag.setCentering,setTargeting:_googletag.setTargeting,destroySlots:_googletag.destroySlots,enableServices:_googletag.enableServices,enableVideoAds:_googletag.enableVideoAds,createGPTScript:_googletag.createGPTScript,setAdIframeTitle:_googletag.setAdIframeTitle,collapseEmptyDivs:_googletag.collapseEmptyDivs,disableInitialLoad:_googletag.disableInitialLoad,enableSingleRequest:_googletag.enableSingleRequest,enableAsyncRendering:_googletag.enableAsyncRendering}};var _default=Provider;exports.default=_default;