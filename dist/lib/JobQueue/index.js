"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _MinHeap=_interopRequireDefault(require("../MinHeap")),_Queue=_interopRequireDefault(require("../Queue")),_Pubsub=_interopRequireDefault(require("../Pubsub")),_lodash=_interopRequireDefault(require("lodash.debounce"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var JobQueue=function a(b){var c=this;_classCallCheck(this,a),_defineProperty(this,"on",function(a,b){return c.pubsub.on(a,b)}),_defineProperty(this,"off",function(a,b){return c.pubsub.off(a,b)}),_defineProperty(this,"start",function(){c.canProcess=!0,c.isProcessing=!0,c.work()}),_defineProperty(this,"stop",function(){return c.canProcess=!1}),_defineProperty(this,"work",function(){c.process(c.q).then(function(){return!c.heap.isEmpty&&c.canProcess?c.work():void(c.isProcessing=!1)})}),_defineProperty(this,"add",function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return a.priority&&a.data?(c.heap.insert({priority:a.priority||1,data:a.data}),c.isProcessing||!c.canProcess)?c:(c.debouncedWork(),c):(console.log("invalid job"),c)}),_defineProperty(this,"grab",function(){for(var a=0,b=new _Queue.default;!c.heap.isEmpty&&a<c.chunkSize;)b.enqueue(c.heap.extract()),a++;return b}),_defineProperty(this,"process",function(){return new Promise(function(a){c.isProcessing=!0,c.emit.jobStart();var b=c.grab();return c.processFn(b,function b(){a(),c.emit.jobEnd()})})}),this.heap=new _MinHeap.default(function(c,a){return c.priority>a.priority}),this.pubsub=new _Pubsub.default,this.delay=b.delay||0,this.isProcessing=!1,this.chunkSize=b.chunkSize||5,this.processFn=b.processFn||function(a,b){b()},this.canProcess=function(){return!1!==b.canProcess&&(!(!0!==b.canProcess)||!0)}(),this.debouncedWork=(0,_lodash.default)(this.work,+this.delay),this.emit={jobStart:function a(){return c.pubsub.emit("jobStart")},jobEnd:function a(){return c.pubsub.emit("jobEnd")}}},_default=JobQueue;exports.default=_default;